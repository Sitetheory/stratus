!function(t,e){"function"==typeof define&&define.amd?define(["stratus","underscore","angular","stratus.services.model"],e):e(t.Stratus,t._)}(this,function(t,e){t.Services.Collection=["$provide",function(n){n.factory("collection",["$q","$http","$timeout","model",function(n,i,a,o){return function(a){this.target=null,this.infinite=!1,this.threshold=.5,this.qualifier="",this.decay=0,a&&"object"==typeof a&&angular.extend(this,a),this.urlRoot="/Api",this.models=[],this.meta=new t.Prototypes.Model,this.model=o,this.pending=!1,this.error=!1,this.completed=!1,this.paginate=!1,this.target&&(this.urlRoot+="/"+e.ucfirst(this.target));var r=this;this.serialize=function(t,e){var n=[];return t=t||{},angular.forEach(t,function(t,i){if(angular.isObject(t))n.push(r.serialize(t,i));else{var a="";e&&(a+=e+"["),a+=i,e&&(a+="]"),n.push(a+"="+t)}}),n.join("&")},this.url=function(){return r.urlRoot},this.sync=function(t,e){return this.pending=!0,n(function(n,a){t=t||"GET";var s={method:t,url:r.url(),headers:{}};angular.isDefined(e)&&("GET"===t?angular.isObject(e)&&Object.keys(e).length&&(s.url+="?"+r.serialize(e)):(s.headers["Content-Type"]="application/json",s.data=JSON.stringify(e))),i(s).then(function(t){if(200===t.status&&angular.isObject(t.data)){r.meta.set(t.data.meta||{}),r.models=[];var e=t.data.payload||t.data;angular.isArray(e)&&e.forEach(function(t){r.models.push(new o({collection:r},t))}),r.pending=!1,r.completed=!0,r.paginate=!1,n(t.data.payload)}else r.pending=!1,r.error=!0,a(t.statusText&&"OK"!==t.statusText?t.statusText:angular.isObject(t.data)?t.data:"Invalid Payload: "+s.method+" "+s.url)})["catch"](a)})},this.fetch=function(t,e){return r.sync(t,e||r.meta.get("api"))["catch"](function(t){console.error("FETCH:",t)})},this.filter=function(t){return r.meta.set("api.q",angular.isDefined(t)?t:""),r.fetch()},this.throttle=e.throttle(this.fetch,1e3),this.throttleFilter=function(t){return r.meta.set("api.q",angular.isDefined(t)?t:""),n(function(t,n){var i=r.throttle();console.log("request:",i),i.then(function(n){console.log("throttled:",e.map(n,function(t){return t.domainPrimary})),t(n)})["catch"](n)})},this.page=function(t){return r.paginate=!0,r.meta.set("api.p",t),r.fetch()},this.toJSON=function(){var t=[];return r.models.forEach(function(e){"function"==typeof e.toJSON&&t.push(e.toJSON())}),t},this.add=function(t,e){e&&"object"==typeof e||(e={}),angular.isObject(t)&&(t=t instanceof o?t:new o({collection:r},t),r.models.push(t),e.save&&t.save())},this.remove=function(t){r.models.splice(r.models.indexOf(t),1)},this.pluck=function(t){return e.map(r.models,function(e){return e instanceof o?e.pluck(t):null})},this.exists=function(t){return!!e.reduce(r.pluck(t)||[],function(t,e){return t||angular.isDefined(e)})}}}])}]});