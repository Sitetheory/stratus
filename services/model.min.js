!function(t,e){"function"==typeof define&&define.amd?define(["stratus","underscore","angular","angular-material"],e):e(t.Stratus,t._)}(this,function(t,e){t.Services.Model=["$provide",function(i){i.factory("model",["$q","$http","$mdToast","$rootScope",function(i,a,n,r){return function(s,o){this.target=null,this.manifest=!1,this.stagger=!1,s&&"object"==typeof s||(s={}),angular.extend(this,s),this.urlRoot="/Api",this.data={},this.meta=new t.Prototypes.Model,e.has(this,"collection")&&(this.collection.target&&(this.target=this.collection.target),this.collection.meta.has("api")&&this.meta.set("api",this.collection.meta.get("api"))),o&&"object"==typeof o&&angular.extend(this.data,o),this.target&&(this.urlRoot+="/"+e.ucfirst(this.target)),this.pending=!1,this.error=!1,this.completed=!1,this.changing=!1,this.changed=0,this.saving=!1,this.watching=!1,this.patch={};var c=this;this.watcher=function(){return!!c.watching||(c.watching=!0,void r.$watch(function(){return c.data},function(i,a){var n=e.patch(i,a);n&&(i.id&&i.id!==a.id&&window.location.replace(t.Internals.SetUrlParams({id:i.id})),c.patch=e.extend(c.patch,n),c.changing=!0,c.changed=1)},!0))},this.url=function(){return c.get("id")?c.urlRoot+"/"+c.get("id"):c.urlRoot},this.serialize=function(t,e){var i=[];return t=t||{},angular.forEach(t,function(t,a){if(angular.isObject(t))i.push(c.serialize(t,a));else{var n="";e&&(n+=e+"["),n+=a,e&&(n+="]"),i.push(n+"="+t)}}),i.join("&")},this.sync=function(t,n){return this.pending=!0,i(function(i,r){t=t||"GET";var s={method:t,url:c.url(),headers:{}};angular.isDefined(n)&&("GET"===t?angular.isObject(n)&&Object.keys(n).length&&(s.url+="?"+c.serialize(n)):(s.headers["Content-Type"]="application/json",s.data=JSON.stringify(n))),a(s).then(function(t){if(200===t.status&&angular.isObject(t.data)){c.meta.set(t.data.meta||{});var a=t.data.payload||t.data;angular.isArray(a)&&a.length?(c.data=e.first(c.data),c.error=!1):angular.isObject(a)?(c.data=a,c.error=!1):c.error=!0,c.error||(c.pending=!1,c.completed=!0,c.saving=!1,c.patch={},c.watcher()),i(c.data)}else c.pending=!1,c.error=!0,r(t.statusText&&"OK"!==t.statusText?t.statusText:angular.isObject(t.data)?t.data:"Invalid Payload: "+s.method+" "+s.url)})["catch"](function(){r("XHR: "+s.method+" "+s.url)})})},this.fetch=function(t,e){return c.sync(t,e||c.meta.get("api"))["catch"](function(t){n.show(n.simple().textContent("Failure to Fetch!").toastClass("errorMessage").position("top right").hideDelay(3e3)),console.error("FETCH:",t)})},this.save=function(){return c.changing=!1,c.saving=!0,c.sync(c.get("id")?"PUT":"POST",c.toJSON({patch:!0}))["catch"](function(t){n.show(n.simple().textContent("Failure to Save!").toastClass("errorMessage").position("top right").hideDelay(3e3)),console.error("SAVE:",t)})},this.throttle=e.throttle(this.save,2e3),this.throttleSave=function(){return i(function(t,e){var i=c.throttle();console.log("throttle request:",i),i.then(function(e){console.log("throttle received:",e),t(e)})["catch"](e)})},this.toJSON=function(t){var e;return e=c.data,e=c.meta.has("api")?{meta:c.meta.get("api"),payload:e}:e,c.meta.size()>0&&c.meta.clearTemp(),e},c.toPatch=function(){return c.patch},this.bracket={match:/\[[\d+]]/,search:/\[([\d+])]/g,attr:/(^[^\[]+)/},this.get=function(t){if("string"==typeof t&&c.data&&"object"==typeof c.data){var i,a,n;return e.reduce(t.split("."),function(t,r){if(r.match(c.bracket.match)){for(a=[],n=c.bracket.attr.exec(r),null!==n?(a.push(n[1]),n=null):n=!1,i=c.bracket.search.exec(r);null!==i;)n!==!1&&(n=parseInt(i[1]),isNaN(n)?n=!1:a.push(n)),i=c.bracket.search.exec(r);return a.length?void 0:e.reduce(a,function(t,e){return t&&t[e]},t)}return t&&t[r]},c.data)}},this.set=function(t,i){t&&"object"==typeof t?e.each(t,function(t,e){c.setAttribute(e,t)},this):c.setAttribute(t,i)},this.setAttribute=function(t,i){if("string"==typeof t&&t.indexOf(".")!==-1){var a=c.data,n=t.split(".");if(t.match(c.bracket.match)&&e.each(n,function(){console.log("chain:",arguments)}),e.find(e.initial(n),function(t){return e.has(a,t)&&a[t]||(a[t]={}),"undefined"!=typeof a&&a&&"object"==typeof a?void(a=a[t]):(a=c.data,!0)},this),!e.isEqual(a,c.data)){var r=e.last(n);a&&"object"==typeof a&&(a[r]=i)}}else c.data[t]=i},this.toggle=function(t,i,a){angular.isObject(a)&&angular.isDefined(a.multiple)&&angular.isUndefined(a.strict)&&(a.strict=!0),a=e.extend({multiple:!0},angular.isObject(a)?a:{});var n=t.split("[]."),r=c.get(n.length>1?n[0]:t);return(angular.isUndefined(r)||a.strict&&angular.isArray(r)!==a.multiple)&&(r=a.multiple?[]:null,c.set(n.length>1?n[0]:t,r)),angular.isUndefined(i)?c.set(t,!r):angular.isArray(r)?c.exists(t,i)?e.each(r,function(t,a){var s=n.length>1&&angular.isObject(t)&&n[1]in t?t[n[1]]:t,o=angular.isObject(s)&&s.id?s.id:s,c=angular.isObject(i)&&i.id?i.id:i;(o===c||angular.isString(o)&&angular.isString(c)&&0===e.strcmp(o,c))&&r.splice(a,1)}):r.push(i):"object"!=typeof r&&"number"!=typeof r||c.set(t,c.exists(t,i)?null:i),c.get(t)},this.pluck=function(t){if(!("string"==typeof t&&t.indexOf("[].")>-1))return c.get(t);var e=t.split("[].");if(e.length>1&&(t=c.get(e[0]),t&&angular.isArray(t))){var i=[];if(t.forEach(function(t){angular.isObject(t)&&e[1]in t&&i.push(t[e[1]])}),i.length)return i}},this.exists=function(t,i){return i?!("string"!=typeof t||!i)&&(t=c.pluck(t),angular.isArray(t)?"undefined"!=typeof t.find(function(t){return t===i||angular.isObject(t)&&t.id&&t.id===i||e.isEqual(t,i)}):t===i||angular.isObject(t)&&t.id&&(e.isEqual(t,i)||t.id===i)):(t=c.get(t),"undefined"!=typeof t&&t)},this.destroy=function(){c.collection&&c.collection.remove(c),c.get("id")&&c.sync("DELETE",{})["catch"](function(t){n.show(n.simple().textContent("Failure to Delete!").toastClass("errorMessage").position("top right").hideDelay(3e3)),console.error("DESTROY:",t)})},this.initialize=e.once(this.initialize||function(){c.manifest&&!c.get("id")&&c.sync("POST",c.meta.has("api")?{meta:c.meta.get("api"),payload:{}}:{})["catch"](function(t){n.show(n.simple().textContent("Failure to Manifest!").toastClass("errorMessage").position("top right").hideDelay(3e3)),console.error("MANIFEST:",t)})}),c.stagger||this.initialize()}}])}]});