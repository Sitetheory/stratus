!function(t,e){"function"==typeof define&&define.amd?define(["stratus","underscore","angular","angular-material"],e):e(t.Stratus,t._,t.angular)}(this,function(t,e,i){t.Services.Model=["$provide",function(n){n.factory("Model",["$q","$http","$mdToast","$rootScope","$log",function(n,s,r,a,o){return function(c,h){this.target=null,this.manifest=!1,this.stagger=!1,this.toast=!1,this.urlRoot="/Api",c&&"object"==typeof c||(c={}),i.extend(this,c),this.identifier=null,this.data={},this.header=new t.Prototypes.Model,this.meta=new t.Prototypes.Model,e.has(this,"collection")&&(this.collection.target&&(this.target=this.collection.target),this.collection.meta.has("api")&&this.meta.set("api",this.collection.meta.get("api"))),h&&"object"==typeof h&&i.extend(this.data,h),this.target&&(this.urlRoot+="/"+e.ucfirst(this.target)),this.pending=!1,this.error=!1,this.completed=!1,this.changed=!1,this.saving=!1,this.watching=!1,this.patch={};const u=this;this.watcher=function(){if(u.watching)return!0;u.watching=!0,a.$watch(function(){return u.data},function(i,n){const s=e.patch(i,n);t.Environment.get("production")||o.log("Patch:",s),s&&(u.changed=!0,(i.id&&i.id!==n.id||u.isNewVersion(i))&&window.location.replace(t.Internals.SetUrlParams({id:i.id})),u.patch=e.extend(u.patch,s))},!0)},this.getIdentifier=function(){return this.identifier=u.get("id")||u.identifier},this.getType=function(){return this.type=u.type||u.target||"orphan"},this.getHash=function(){return this.getType()+(e.isNumber(this.getIdentifier())?this.getIdentifier().toString():this.getIdentifier())},this.url=function(){let t=u.getIdentifier()?u.urlRoot+"/"+u.getIdentifier():u.urlRoot+(u.targetSuffix||"");return e.getUrlParams("version")&&(t+=t.includes("?")?"&":"?",t+="options[version]="+e.getUrlParams("version")),t},this.serialize=function(t,e){const n=[];return t=t||{},i.forEach(t,function(t,s){if(i.isObject(t))e&&(s=e+"["+s+"]"),n.push(u.serialize(t,s));else{let i="";e&&(i+=e+"["),i+=s,e&&(i+="]"),n.push(i+"="+t)}}),n.join("&")},this.sync=function(r,a,c){return this.pending=!0,n(function(n,h){c=c||{};const l={method:r=r||"GET",url:u.url(),headers:{}};i.isDefined(a)&&("GET"===r?i.isObject(a)&&Object.keys(a).length&&(l.url+=l.url.includes("?")?"&":"?",l.url+=u.serialize(a)):(l.headers["Content-Type"]="application/json",l.data=JSON.stringify(a))),t.Environment.get("production")||o.log("Prototype:",l),c.hasOwnProperty("headers")&&"object"==typeof c.headers&&Object.keys(c.headers).forEach(function(t){l.headers[t]=c.headers[t]}),s(l).then(function(t){if(200===t.status&&i.isObject(t.data)){u.header.set(t.headers()||{}),u.meta.set(t.data.meta||{});const s=t.data.payload||t.data;u.meta.has("status")&&"SUCCESS"!==e.first(u.meta.get("status")).code?u.error=!0:i.isArray(s)&&s.length?(u.data=e.first(s),u.error=!1):i.isObject(s)&&!i.isArray(s)?(u.data=s,u.error=!1):u.error=!0,u.error||(u.completed=!0,u.saving=!1,u.patch={},u.watcher(),setTimeout(function(){u.changed=!1},100)),u.pending=!1,n(u.data)}else u.pending=!1,u.error=!0,h(t.statusText&&"OK"!==t.statusText?t.statusText:i.isObject(t.data)?t.data:"Invalid Payload: "+l.method+" "+l.url,t)}).catch(function(){h("XHR: "+l.method+" "+l.url)})})},this.fetch=function(t,e,i){return u.sync(t,e||u.meta.get("api"),i).catch(function(t){u.toast&&r.show(r.simple().textContent("Failure to Fetch!").toastClass("errorMessage").position("top right").hideDelay(3e3)),o.error("FETCH:",t)})},this.save=function(){return u.saving=!0,u.sync(u.getIdentifier()?"PUT":"POST",u.toJSON({patch:!0})).catch(function(t){u.toast&&r.show(r.simple().textContent("Failure to Save!").toastClass("errorMessage").position("top right").hideDelay(3e3)),o.error("SAVE:",t)})},this.specialAction=function(t){this.meta.temp("api.options.apiSpecialAction",t),this.save(),this.meta.get("api")&&this.meta.get("api").hasOwnProperty("options")&&this.meta.get("api").options.hasOwnProperty("apiSpecialAction")&&delete this.meta.get("api").options.apiSpecialAction},this.throttle=e.throttle(this.save,2e3),this.throttleSave=function(){return n(function(t,e){const i=u.throttle();o.log("throttle request:",i),i.then(function(e){o.log("throttle received:",e),t(e)}).catch(e)})},this.toJSON=function(t){let e;return e=u.data,e=u.meta.has("api")?{meta:u.meta.get("api"),payload:e}:e,u.meta.size()>0&&u.meta.clearTemp(),e},u.toPatch=function(){return u.patch},this.bracket={match:/\[[\d+]]/,search:/\[([\d+])]/g,attr:/(^[^[]+)/},this.buildPath=function(t){const i=[];if(!e.isString(t))return i;let n,s;return e.each(t.split("."),function(t){if(t.match(u.bracket.match))for(null!==(n=u.bracket.attr.exec(t))?(i.push(n[1]),n=null):n=!1,s=u.bracket.search.exec(t);null!==s;)!1!==n&&(n=parseInt(s[1]),isNaN(n)?n=!1:i.push(n)),s=u.bracket.search.exec(t);else i.push(t)}),i},this.get=function(t){return"string"==typeof t&&u.data&&"object"==typeof u.data?u.buildPath(t).reduce(function(t,e){return t&&t[e]},u.data):void 0},this.find=function(t,e,i){return"string"==typeof t&&(t=u.get(t)),t instanceof Array?t.find(function(t){return t[e]===i}):t},this.moreParams=function(){let t,e={};return location.hash.split("#").forEach(function(i){i&&((t=i.split("/")).length<=1||(e[t[0]]=t[1]))}),e},this.isNewVersion=function(t){return!e.isEmpty(this.moreParams())&&t.version&&parseInt(this.moreParams().version)!==t.version.id},this.set=function(t,i){t&&"object"==typeof t?e.each(t,function(t,e){u.setAttribute(e,t)},this):u.setAttribute(t,i)},this.setAttribute=function(t,i){if("string"==typeof t&&(e.contains(t,".")||e.contains(t,"["))){let n;u.buildPath(t).reduce(function(t,s,r,a){return n=r+1,e.has(t,s)||(t[s]=e.has(a,n)&&e.isNumber(a[n])?[]:{}),e.has(a,n)||(t[s]=i),t&&t[s]},u.data)}else u.data[t]=i},this.toggle=function(t,n,s){i.isObject(s)&&i.isDefined(s.multiple)&&i.isUndefined(s.strict)&&(s.strict=!0),s=e.extend({multiple:!0},i.isObject(s)?s:{});const r=t.split("[].");let a=u.get(r.length>1?r[0]:t);return(i.isUndefined(a)||s.strict&&i.isArray(a)!==s.multiple)&&(a=s.multiple?[]:null,u.set(r.length>1?r[0]:t,a)),i.isArray(a)?i.isUndefined(n)?u.set(t,null):u.exists(t,n)?e.each(a,function(t,s){const o=r.length>1&&i.isObject(t)&&r[1]in t?t[r[1]]:t,c=i.isObject(o)&&o.id?o.id:o,h=i.isObject(n)&&n.id?n.id:n;(c===h||i.isString(c)&&i.isString(h)&&0===e.strcmp(c,h))&&a.splice(s,1)}):a.push(n):"object"==typeof a||"number"==typeof a?u.set(t,u.exists(t,n)?null:n):i.isUndefined(n)&&u.set(t,!a),u.get(t)},this.pluck=function(t){if("string"!=typeof t||-1===t.indexOf("[]."))return u.get(t);const e=t.split("[].");if(e.length<=1)return;if(!(t=u.get(e[0]))||!i.isArray(t))return;const n=[];return t.forEach(function(t){i.isObject(t)&&e[1]in t&&n.push(t[e[1]])}),n.length?n:void 0},this.exists=function(t,n){return n?!("string"!=typeof t||!n)&&(t=u.pluck(t),i.isArray(t)?void 0!==t.find(function(t){return t===n||i.isObject(t)&&t.id&&t.id===n||e.isEqual(t,n)}):t===n||i.isObject(t)&&t.id&&(e.isEqual(t,n)||t.id===n)):void 0!==(t=u.get(t))&&t},this.destroy=function(){u.collection&&u.collection.remove(u),u.getIdentifier()&&u.sync("DELETE",{}).catch(function(t){u.toast&&r.show(r.simple().textContent("Failure to Delete!").toastClass("errorMessage").position("top right").hideDelay(3e3)),o.error("DESTROY:",t)})},this.initialize=e.once(this.initialize||function(){u.manifest&&!u.getIdentifier()&&u.sync("POST",u.meta.has("api")?{meta:u.meta.get("api"),payload:{}}:{}).catch(function(t){u.toast&&r.show(r.simple().textContent("Failure to Manifest!").toastClass("errorMessage").position("top right").hideDelay(3e3)),o.error("MANIFEST:",t)})}),u.stagger||this.initialize()}}])}]});