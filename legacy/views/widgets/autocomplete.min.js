!function(e,t){"function"==typeof define&&define.amd?define(["stratus","zepto","underscore","stratus.views.widgets.base","selectize"],t):t(e.Stratus,e.$,e._)}(this,function(e,t,i){e.Views.Widgets.Autocomplete=e.Views.Widgets.Base.extend({model:e.Models.Generic,template:i.template('<div><span class="title"><span class="name">{{ (typeof model === "object" && model && _.has(model, "id")) ? model.id : "item" }}</span></span></div>'),url:"/Api/",options:{"private":{requiredCssFile:[e.BaseUrl+"sitetheorycore/css/sitetheory.selectize.css"],selectize:{preload:!0,delimiter:null,plugins:null,items:null,valueField:"id",labelField:"id",searchField:["id"],maxItems:1,create:!0,persist:!1,allowEmptyOption:!1}},"public":{target:null,api:null,decouple:!1}},initialize:function(t){return this.$el.dataAttr("entity")&&this.$el.dataAttr("id")&&(this.options.forceType="model"),e.Views.Widgets.Base.prototype.initialize.call(this,t)},postOptions:function(s){if(null!==this.options.target){var n=i.ucfirst(this.options.target);this.url="/Api/"+n+"/",e.Collections.has(n)||e.Collections.set(n,new e.Collections.Generic({entity:n,initialize:!0})),this.suggestions=e.Collections.get(n)}this.getDataOptions(this.options.selectize),this.options.selectize.render={option:function(e,t){return this.template({model:e,options:this.options,scope:"suggestion"})}.bind(this)},this.options.selectize.load=function(e,s){if(!e.length&&!this.initial.request)return s();if(this.initial.request=!1,!this.options.decouple&&i.has(this,"suggestions")){var n={};e.length?(this.suggestions.meta.set("api.query",e),this.suggestions.once("success",function(){n=this.suggestions.toJSON(),s(i.has(n,"payload")?n.payload:n)},this),this.suggestions.refresh({reset:!0})):(n=this.suggestions.toJSON(),s(i.has(n,"payload")?n.payload:n))}else t.ajax({url:this.url+"?query="+e+"&"+t.param({options:this.options.api}),type:"GET",error:function(){s()},success:function(e){s(e.payload)}})}.bind(this)},promise:function(t,s,n){i.contains(this.options.selectize.plugins,"drag_drop")?require(["jquery-ui"],function(){e.Views.Widgets.Base.prototype.promise.call(this,t,s,n)}.bind(this)):e.Views.Widgets.Base.prototype.promise.call(this,t,s,n)},storeElement:function(e){var t=this.$el;this.options.label&&(this.$el.append('<div class="autocomplete"></div>'),t=this.$el.find(".autocomplete")),t.selectize(this.options.selectize),this.initial=this.initial||{request:!0,load:!0},this.$element=t[0].selectize,this.registeredElement=!1},onRender:function(e){var t=this;return this.$element.on("load",function(){t.initial.load&&(t.initial.load=!1,null!==t.options.selectize.items&&t.options.selectize.items.length>0&&i.each(t.options.selectize.items,function(e){if(!i.has(this.options,e)){var s={};s[t.options.selectize.valueField]=e,s[t.options.selectize.labelField]=e,this.addOption(s)}this.setValue([e])},this),i.has(t,"selected")&&this.setValue(t.selected))}),!0},getValue:function(){if(!this.$element||"object"!=typeof this.$element||"undefined"!=typeof this.$element.length&&!this.$element.length)return!1;var e=[],t=this.$element.getValue();if(t=t.length?t.split(","):null){var s;i.each(t,function(t){s=parseInt(t),isNaN(s)||e.push({id:s})},e)}return e},setValue:function(e){if(!this.$element||"object"!=typeof this.$element||"undefined"!=typeof this.$element.length&&!this.$element.length)return!1;this.selected=[];var t="";return e&&e.length&&i.each(e,function(e){e&&"object"==typeof e&&i.has(e,"id")&&(t.length&&(t+=","),t+=e.id,this.selected.push(e.id))},this),this.$el.dataAttr("value",t),this.$element.setValue(this.selected),!0}})});