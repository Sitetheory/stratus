(function(root,factory){if(typeof define==="function"&&define.amd){define(["stratus","underscore","angular","stratus.services.model"],factory)}else{factory(root.Stratus,root._)}})(this,function(Stratus,_){Stratus.Directives.Edit=function($parse,$log,model){return{restrict:"A",require:"ngModel",scope:{ngModel:"=",property:"@",emptyValue:"@",prefix:"@",stratusEdit:"=",alwaysEdit:"@",autoSave:"@"},link:function($scope,$element,$attrs,ngModel){$scope.uid=this.uid=_.uniqueId("edit_");Stratus.Instances[this.uid]=$scope;$scope.model=null;$scope.value=$element.html();if(!ngModel||!$scope.property){console.warn($scope.uid+" has no model or property!");return}var ctrl={initialized:false};ngModel.$render=function(){$element.html(($scope.prefix||"")+($scope.value||$scope.emptyValue||""))};$scope.liveEditStatus=function(){if(ctrl.initialized){if($scope.stratusEdit!==undefined){return $scope.stratusEdit}else if(Stratus.Environment.data.liveEdit!==undefined){return Stratus.Environment.data.liveEdit}console.warn($scope.uid+" has no variable to track edit toggle! ($scope.stratusEdit)")}return false};$scope.read=function(){if(ctrl.initialized){$scope.value=$element.html();if($scope.prefix){$scope.value=$scope.value.replace($scope.prefix,"")}}};$scope.accept=function(){if(ctrl.initialized&&$scope.model instanceof model&&$scope.property&&$scope.model.get($scope.property)!==$scope.value){$scope.model.set($scope.property,$scope.value);$scope.model.save()}};$scope.cancel=function(){if(ctrl.initialized&&$scope.model instanceof model&&$scope.property){$scope.value=$scope.model.get($scope.property)}};$scope.$watch("ngModel",function(data){if(data instanceof model&&!_.isEqual(data,$scope.model)){$scope.model=data;var unwatch=$scope.$watch("model.data",function(){unwatch();ctrl.init()})}});ctrl.init=function(){if(!ctrl.initialized){ctrl.initialized=true;$scope.$watch("model.data."+$scope.property,function(data){$scope.value=data;ngModel.$render()});if($scope.alwaysEdit!==true&&$scope.alwaysEdit!=="true"){$scope.$watch($scope.liveEditStatus,function(liveEdit){$element.attr("contenteditable",liveEdit);if(liveEdit){$element.addClass("liveEdit")}else{$element.removeClass("liveEdit")}})}else{$element.attr("contenteditable",true)}$element.on("focusout keyup change",function(){if(ctrl.initialized){$scope.$apply($scope.read);if($scope.autoSave!==false&&$scope.autoSave!=="false"){switch(event.type){case"focusout":case"blur":$scope.$apply($scope.accept);break}}}});$element.on("keydown keypress",function(event){if(ctrl.initialized){switch(event.which){case Stratus.Key.Enter:event.preventDefault();if($scope.autoSave!==false&&$scope.autoSave!=="false"){$scope.$apply($scope.accept)}break;case Stratus.Key.Escape:$scope.$apply($scope.cancel);break}}})}}}}}});