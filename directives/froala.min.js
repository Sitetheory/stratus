!function(root,factory){"function"==typeof define&&define.amd?define(["stratus","jquery","froala","angular"],factory):factory(root.Stratus,root.$)}(this,function(Stratus,$){Stratus.Directives.Froala=["froalaConfig",function(froalaConfig){"use strict";var generatedIds=0,defaultConfig={immediateAngularModelUpdate:!1,angularIgnoreAttrs:null},innerHtmlAttr="innerHTML",scope={froalaOptions:"=stratusFroala",initFunction:"&froalaInit"};froalaConfig=froalaConfig||{},console.log("froalaConfig:",froalaConfig);var MANUAL="manual",AUTOMATIC="automatic",SPECIAL_TAGS=["img","button","input","a"];return{restrict:"A",require:"ngModel",scope:scope,link:function(scope,element,attrs,ngModel){element=element.length?$(element[0]):element;var specialTag=!1;SPECIAL_TAGS.indexOf(element.prop("tagName").toLowerCase())!=-1&&(specialTag=!0);var ctrl={editorInitialized:!1};if(scope.initMode=attrs.froalaInit?MANUAL:AUTOMATIC,ctrl.init=function(){attrs.id||attrs.$set("id","froala-"+generatedIds++),scope.initMode===AUTOMATIC&&ctrl.createEditor(),ngModel.$render=function(){if(ctrl.editorInitialized)if(specialTag){var tags=ngModel.$modelValue;if(tags){for(var attr in tags)tags.hasOwnProperty(attr)&&attr!=innerHtmlAttr&&element.attr(attr,tags[attr]);tags.hasOwnProperty(innerHtmlAttr)&&(element[0].innerHTML=tags[innerHtmlAttr])}}else element.froalaEditor("html.set",ngModel.$viewValue||"",!0),element.froalaEditor("undo.reset"),element.froalaEditor("undo.saveStep")},ngModel.$isEmpty=function(value){if(!value)return!0;var isEmpty=element.froalaEditor("node.isEmpty",$("<div>"+value+"</div>").get(0));return isEmpty}},ctrl.createEditor=function(froalaInitOptions){if(ctrl.listeningEvents=["froalaEditor"],!ctrl.editorInitialized){froalaInitOptions=froalaInitOptions||{},ctrl.options=angular.extend({},defaultConfig,froalaConfig,scope.froalaOptions,froalaInitOptions),ctrl.options.immediateAngularModelUpdate&&ctrl.listeningEvents.push("keyup");var flushNgModel=function(){ctrl.editorInitialized=!0,ngModel.$render()};specialTag?flushNgModel():ctrl.registerEventsWithCallbacks("froalaEditor.initialized",function(){flushNgModel()});for(var eventName in ctrl.options.events)ctrl.options.events.hasOwnProperty(eventName)&&ctrl.registerEventsWithCallbacks(eventName,ctrl.options.events[eventName]);ctrl.froalaElement=element.froalaEditor(ctrl.options).data("froala.editor").$el,ctrl.froalaEditor=angular.bind(element,element.froalaEditor),ctrl.initListeners(),scope.froalaOptions&&(scope.froalaOptions.froalaEditor=ctrl.froalaEditor)}},ctrl.initListeners=function(){ctrl.options.immediateAngularModelUpdate&&ctrl.froalaElement.on("keyup",function(){scope.$evalAsync(ctrl.updateModelView)}),element.on("froalaEditor.contentChanged",function(){scope.$evalAsync(ctrl.updateModelView)}),element.bind("$destroy",function(){element.off(ctrl.listeningEvents.join(" ")),element.froalaEditor("destroy"),element=null})},ctrl.updateModelView=function(){var modelContent=null;if(specialTag){for(var attributeNodes=element[0].attributes,attrs={},i=0;i<attributeNodes.length;i++){var attrName=attributeNodes[i].name;ctrl.options.angularIgnoreAttrs&&ctrl.options.angularIgnoreAttrs.indexOf(attrName)!==-1||(attrs[attrName]=attributeNodes[i].value)}element[0].innerHTML&&(attrs[innerHtmlAttr]=element[0].innerHTML),modelContent=attrs}else{var returnedHtml=element.froalaEditor("html.get");angular.isString(returnedHtml)&&(modelContent=returnedHtml)}ngModel.$setViewValue(modelContent),scope.$root.$$phase||scope.$apply()},ctrl.registerEventsWithCallbacks=function(eventName,callback){eventName&&callback&&(ctrl.listeningEvents.push(eventName),element.on(eventName,callback))},scope.initMode===MANUAL){var _ctrl=ctrl,controls={initialize:ctrl.createEditor,destroy:function(){_ctrl.froalaEditor&&(_ctrl.froalaEditor("destroy"),_ctrl.editorInitialized=!1)},getEditor:function(){return _ctrl.froalaEditor?_ctrl.froalaEditor:null}};scope.initFunction({initControls:controls})}ctrl.init()}}}],Stratus.Directives.FroalaView=["$sce",function($sce){return{restrict:"ACM",scope:!1,link:function(scope,element,attrs){element.addClass("fr-view"),scope.$watch(attrs.froalaView,function(nv){if(nv||""===nv){var explicitlyTrustedValue=$sce.trustAsHtml(nv);element.html(explicitlyTrustedValue.toString())}})}}}]});