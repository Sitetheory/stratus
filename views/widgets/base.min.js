//     Stratus.Views.Widgets.Base.js 1.0
//     Copyright (c) 2016 by Sitetheory, All Rights Reserved
//
//     All information contained herein is, and remains the
//     property of Sitetheory and its suppliers, if any.
//     The intellectual and technical concepts contained herein
//     are proprietary to Sitetheory and its suppliers and may be
//     covered by U.S. and Foreign Patents, patents in process,
//     and are protected by trade secret or copyright law.
//     Dissemination of this information or reproduction of this
//     material is strictly forbidden unless prior written
//     permission is obtained from Sitetheory.
//
//     For full details and documentation:
//     http://docs.sitetheory.io
!function(t,e){"function"==typeof define&&define.amd?define(["stratus","jquery","underscore","tether","moment","promise","stratus.views.base","stratus.models.generic","stratus.collections.generic"],e):e(t.Stratus,t.$,t._,t.Tether,t.moment)}(this,function(t,e,i,s,n){t.Views.Widgets.Base=t.Views.Base.extend({model:t.Models.Generic,collection:t.Collections.Generic,dispatch:t.Prototypes.Dispatch,uid:"unset",templateContainer:i.template('{% if(options.label) { %}<label class="control-label" for="{{ elementId }}">{{ options.label }}</label>{% } %}{% if(options.help) { %}<span data-plugin="help" data-content="{{ options.help }}"></span>{% } %}{{ template }}{% if(options.feedback) { %}<span class="form-control-feedback" aria-hidden="true"></span>{% } %}'),defaults:{"private":{dataType:"model",autoSave:!1,autoSaveInterval:"3s",unrenderEventDefault:"blur",autoLoader:!0,forceType:null,requiredCssFile:[]},"public":{editable:!0,emptyValue:null,placeholder:"Click to Edit",before:"",after:"",style:null,formControl:!1,label:null,help:null,feedback:null,render:"auto",unrender:null,format:null,interval:null,collectionMin:null,limit:null,autosort:!1,cssFile:[]}},options:{"private":{},"public":{}},isRendered:!1,templateRender:"render",elementId:null,isFocused:!1,registeredEvents:!1,renderTrigger:!1,liveEditTrigger:!1,registered:!1,registeredElement:!1,element:null,$element:function(){return this.element?e("#"+this.element):null},initialize:function(e){return this.dispatch=new t.Prototypes.Dispatch,this.primeEvents(),this.initializer=new Promise(function(i,s){this.prepare(e)?this.fork(e,i,s):s(new t.Prototypes.Error("Prepare",this))}.bind(this)),!0},primeEvents:function(){return this.registeredEvents=this.registeredEvents||this.registerEvents(),!0},registerEvents:function(){this.on("render",this.onRender,this),this.on("render",this.dispatchTrigger,this),this.on("unrender",this.onUnrender,this),this.on("postrender",this.onPostRender,this),this.on("register",this.primeRegister,this);var t=this.model&&"object"==typeof this.model?"model":this.collection&&"object"==typeof this.collection?"collection":null;return t&&(this[t].isHydrated()||this.setStatus("load"),this[t].on("request",function(){this.setStatus("request")}.bind(this)),this[t].on("error",function(){this.setStatus("error"),this.onError.apply(this,arguments)}.bind(this)),this[t].on("success",function(){this.setStatus("success")}.bind(this)),"model"===t&&this.model.on("destroy",function(){this.$el.html("")}.bind(this))),!0},onError:function(t,e,i){return!0},fork:function(e,i,s){var n=!0;return this.collection&&"object"==typeof this.collection&&!this.collection.isHydrated()?this.collection.once("success",function(){this.fork(e,i,s)},this):this.model&&"object"==typeof this.model&&!this.model.isHydrated()?(this.model.once("success",function(){this.model.once("change",function(){this.fork(e,i,s)},this)},this),this.model.once("error",function(){s(new t.Prototypes.Error(this.model.entity+" does not exist",this))},this)):(this.$el.removeClass("has-load"),this.promise(e,i,s)),n},prepare:function(e){return this.uid=i.has(e,"uid")?e.uid:null,this.type=e.type.toLowerCase(),this.view=e.view,this.api=e.api,this.target=e.target,this.propertyName=e.property,this.propertyValue=null,this.element=this.$el.data("id")?this.$el.data("id"):i.uniqueId("Widget-"),this.preOptions(e),this.options={"private":this.options["private"]&&i.size(this.options["private"])?i.extend(i.cloneDeep(this.defaults["private"]),i.cloneDeep(this.options["private"])):i.cloneDeep(this.defaults["private"]),"public":this.options["public"]&&i.size(this.options["public"])?i.extend(i.cloneDeep(this.defaults["public"]),i.cloneDeep(this.options["public"])):i.cloneDeep(this.defaults["public"])},this.getDataOptions(this.options["public"]),this.options=i.extend(this.options["public"],this.options["private"]),this.mergeOptions(e),this.mergeCssOptions(e),this.postOptions(e),this.setCollectionView(e),this.validate()?(this.options.dataType=this.model&&"object"==typeof this.model?"model":this.collection&&"object"==typeof this.collection?"collection":"var","var"===this.options.dataType&&"undefined"==typeof t.Environment.get(this.propertyName)&&t.Environment.set(this.propertyName,this.options.emptyValue),this.getStandardData(),this.selectTemplate(e),!0):!1},mergeCssOptions:function(t){this.options.cssFile="string"===this.options.cssFile?[this.options.cssFile]:i.isArray(this.options.cssFile)?this.options.cssFile:[],this.options.requiredCssFile="string"===this.options.requiredCssFile?[this.options.requiredCssFile]:i.isArray(this.options.requiredCssFile)?this.options.requiredCssFile:[],this.options.cssFile=i.union(this.options.cssFile,this.options.requiredCssFile)},preOptions:function(t){},setStatus:function(t){this.$el.attr("data-status",t);var e={request:this.$el.hasClass("has-request"),error:this.$el.hasClass("has-error"),change:this.$el.hasClass("has-change")};return("request"!==t||e.change)&&("error"!==t||e.change)&&("success"!==t||e.change||e.error||e.request)?(this.$el.removeClass(function(t,e){return(e.match(/(^|\s)has-\S+/g)||[]).join(" ").replace("has-feedback")}),this.$el.addClass("has-"+t),!0):!1},mergeOptions:function(t){return i.has(t,"options")&&null!==t.options&&(i.each(this.options,function(e,s){"undefined"!=typeof t.options[s]&&("object"==typeof e?this.options[s]=i.defaults(t.options[s],this.options[s]):this.options[s]=t.options[s])},this),i.has(t.options,"api")&&("object"!=typeof this.model||this.model.meta.has("api")?"object"!=typeof this.collection||this.collection.meta.has("api")||this.collection.meta.set("api",t.options.api):this.model.meta.set("api",t.options.api))),!0},postOptions:function(t){},getDataOptions:function(t){if(!t)return!1;var e={key:null,value:null};return i.each(t,function(i,s){e.key=s.toLowerCase(),e.value=this.$el.dataAttr(e.key),void 0!==e.value&&(t[s]=e.value)},this),t},setCollectionView:function(t){return"collectionView"in t?this.collectionView=t.collectionView:this.collectionView={},"globals"in t?(this.globals=t.globals,this.model.globals=t.globals):this.globals={},!0},selectTemplate:function(t){if(this.options.render===!1)return this.template=null,!1;var s=t.templates&&i.has(t.templates,this.templateRender)?t.templates[this.templateRender]:"#render_"+this.$el.attr("id");if(i.has(t.templates,"combined")&&(s=t.templates.combined),"function"==typeof s)this.template=s;else if(0===s.indexOf("#")){var n=e(s);n.length>0&&(this.template=i.template(n.html()))}return!0},getStandardData:function(){return"auto"!==this.options.render&&null===this.options.unrender&&this.options.unrender!==!1&&(this.options.unrender=this.options.unrenderEventDefault),this.options.editable&&(null===this.options.style&&(this.options.style="form"),this.options.autoSave&&this.model&&"object"==typeof this.model&&this.model.autoSave(this.options.autoSave)),this.options.feedback=!(!this.options.feedback&&"form"!==this.options.style),!0},validate:function(){return!0},promise:function(e,s,n){!this.options.forceType||i.has(this,this.options.forceType)&&"object"==typeof this[this.options.forceType]?i.size(this.options.cssFile)?t.Internals.LoadCss(this.options.cssFile).done(function(){this.render(),s(this)}.bind(this),function(e){n(new t.Prototypes.Error(e,this))}.bind(this)):(this.render(),s(this)):n(new t.Prototypes.Error(i.ucfirst(this.options.forceType)+" not present on widget.",this))},render:function(){return null===this.template||"function"!=typeof this.template?(this.storeElement(t.Views.Widgets.Base.prototype.$element.call(this)),this.primeElement(),this.renderEvent(),this.isRendered=!0,!1):("auto"===this.options.render?this.renderTemplate():(this.primeRenderTrigger(),this.primeLiveEdit(),this.unrender()),!0)},primeRenderTrigger:function(){return this.renderTrigger=this.renderTrigger||this.registerRenderTrigger(),!0},registerRenderTrigger:function(){return this.$el.on(this.options.render,function(){!this.isRendered&&t.Environment.get("liveEdit")&&this.renderTemplate()}.bind(this)),!0},primeLiveEdit:function(){return this.liveEditTrigger=this.liveEditTrigger||this.registerLiveEdit(),!0},registerLiveEdit:function(){return t.Environment.on("change:liveEdit",function(){t.Environment.get("liveEdit")?this.liveEditOn():this.liveEditOff()}.bind(this)),!0},renderTemplate:function(){var e,o={el:this.$el,elementId:this.element,property:this.propertyName,options:this.options,scope:"entity",environment:t.Environment.attributes,moment:n,tether:s,globals:i.has(this,"globals")?this.globals:{},icon:i.has(this,"icon")?this.icon:{}};return this.model&&"object"==typeof this.model&&(o.model=this.model.attributes,o.meta=this.model.meta.toObject()),this.collection&&"object"==typeof this.collection&&(o.collection=this.collection.models,o.meta=this.collection.meta.toObject()),e=this.template(o),"auto"!==this.options.render&&this.setStatus("render"),this.$el.html(this.renderContainer(e)),this.storeElement(t.Views.Widgets.Base.prototype.$element.call(this)),"form"===this.options.style?(this.$el.addClass("form-group has-feedback"),t.Environment.get("liveEdit")&&!this.options.formControl||!this.$element.addClass||this.$element.addClass("form-control")):this.$el.addClass("widgetContainer"),this.primeElement(),this.options.autoLoader&&this.autoload(),this.options.unrender&&this.options.unrender!==!0&&this.$element.on(this.options.unrender,function(t){this.unrender()}.bind(this)),this.options.autoLoader||this.renderEvent(),!0},storeElement:function(t){"function"!=typeof this.$element&&i.isEqual(this.$element,t)||(this.$element=t,this.registeredElement=!1)},primeElement:function(){return this.registeredElement=this.registeredElement||this.registerElement(),!0},registerElement:function(){return!this.$element||"object"!=typeof this.$element||"undefined"!=typeof this.$element.length&&!this.$element.length?!1:(this.$element.on("focus",function(t){this.focusAction(t)}.bind(this)),this.$element.on("blur",function(t){this.blurAction(t)}.bind(this)),this.$element.on("keydown",function(t){this.keyActions(t)}.bind(this)),this.$element.on("click",function(t){this.editAction(t)}.bind(this)),!0)},autoload:function(){t.Internals.Loader(this.el||this.$el,this.view).done(function(e){t.Internals.Loader(this.$el.find("[data-entity]")).done(function(t){this.loaderCallback(e,t)}.bind(this))}.bind(this))},renderContainer:function(t){return this.templateContainer({template:t,elementId:this.element,options:this.options})},liveEditOn:function(){if("undefined"===this.getValue()||!t.Environment.get("liveEdit"))return!1;var e=this.getPropertyValue();!this.isRendered&&e===this.options.emptyValue},liveEditOff:function(){return"undefined"!==this.getValue()?this.unrender():!1},unrender:function(){if(!this.options.unrender)return!1;this.safeSaveAction({saveNow:!0});var t=this.options.before+this.getDisplayValue()+this.options.after;t=null===t?"":t,this.$el.html(t),this.isRendered=!1,this.liveEditOn(),this.trigger("unrender")},loaderCallback:function(t,e){var s={parent:e,nest:t},n=function(t){t.dispatch=this.dispatch};return e&&"object"==typeof e&&e.total>0&&i.each(e.views,n,this),t&&"object"==typeof t&&t.total>0&&i.each(t.views,n,this),this.renderEvent(s),s},primeIdleCheck:function(){return this.$element?(this.idleJob=this.idleJob||t.Chronos.add(this.options.autoSaveInterval,this.idleCheck,this),t.Chronos.toggle(this.idleJob,this.isFocused)):!1},idleCheck:function(){return this._timestamp&&Date.now()-this._timestamp>1e3*i.seconds(this.options.autoSaveInterval)&&(this._timestamp=null,this.savePropertyValue()),!0},focusAction:function(t){return this.isFocused||(this.isFocused=!0,this.$el.addClass("editing"),this.primeIdleCheck()),!0},savePropertyValue:function(){return this.getValue()!==this.getPropertyValue()&&(this.setPropertyValue(this.getValue()),this.safeSaveAction()),!0},blurAction:function(t){return this.isFocused&&(this.isFocused=!1,this.$el.removeClass("editing"),this.primeIdleCheck(),this.savePropertyValue(),this.isRendered&&this.options.unrender&&this.unrender()),!0},focus:function(){this.$elementInput?this.$elementInput.focus():this.$element&&this.$element.length&&this.$element.focus()},blur:function(){this.$elementInput?this.$elementInput.blur():this.$element&&this.$element.length&&this.$element.blur()},keyActions:function(i){return i.keyCode===t.Key.Enter&&(i.preventDefault(),e(i.target).blur()),i.keyCode===t.Key.Escape&&(i.preventDefault(),this.closeAction(i)),this._timestamp=Date.now(),!0},editAction:function(t){return e(t.target).focus(),!0},closeAction:function(t){return this.scopeChanged(),e(t.target).blur(),!0},safeSaveAction:function(t){return this.propertyName&&"model"===this.options.dataType&&this.isRendered&&this.options.editable?(this.saveAction(t),!0):!1},getPropertyValue:function(){return"model"===this.options.dataType?this.model.get(this.propertyName):"var"===this.options.dataType?t.Environment.get(this.propertyName):!1},getPropertyValues:function(){var t=this.getPropertyValue();i.isArray(t)||(t=[t]);var e=[];return i.each(t,function(t){i.isObject(t)?i.has(t,"id")&&e.push(t.id):e.push(t)}),e},setPropertyValue:function(e){if(this.getPropertyValue()===e)return!0;this.setStatus("change");var s=this.propertyName;if(null===e&&"string"==typeof s&&-1!==s.indexOf(".")){var n=s.split(".");"id"===i.last(n)&&(s=s.slice(0,-3))}return"boolean"==typeof e||e||(e=this.options.emptyValue),"model"===this.options.dataType?this.model.set(s,e):"var"===this.options.dataType?t.Environment.set(s,e):!1},getValue:function(){return"undefined"},setValue:function(t){return t},getDisplayValue:function(){return this.formatDisplayValue(this.getPropertyValue())},formatDisplayValue:function(t){return t},saveAction:function(t){return this.propertyName?(void 0===t&&(t={}),!this.model||"object"!=typeof this.model||this.options.autoSave&&!t.saveNow||this.model.saveInterval(),!0):!1},scopeChanged:function(){if(!this.propertyName)return!1;if(this.isFocused){if(!this.isRendered&&this.options.unrender){this.options.before+this.getDisplayValue()+this.options.after}}else this.setValue(this.getPropertyValue());return!0},dispatchTrigger:function(t){return this.dispatch.trigger("render",t),!0},renderEvent:function(t){return this.primePostRender(),this.trigger("render",t||this),this},primePostRender:function(){this.once("render",function(){this.trigger("postrender")},this)},onRender:function(t){return!0},onPostRender:function(t){return this.isRendered=!0,this.scopeChanged(),"auto"!==this.options.render&&this.focus(),this.trigger("register"),!0},onUnrender:function(t){return this},primeRegister:function(){return this.registered=this.registered||this.onRegister(),!0},onRegister:function(){var e=this.propertyName||"change";return"change"!==e&&(e="change:"+e),this.model&&"object"==typeof this.model?this.model.on(e,this.scopeChanged,this):"var"===this.options.dataType&&t.Environment.on(e,this.scopeChanged,this),!0}})});