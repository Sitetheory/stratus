//     Stratus.Views.Widgets.Calendar.js 1.0
//     Copyright (c) 2016 by Sitetheory, All Rights Reserved
//
//     All information contained herein is, and remains the
//     property of Sitetheory and its suppliers, if any.
//     The intellectual and technical concepts contained herein
//     are proprietary to Sitetheory and its suppliers and may be
//     covered by U.S. and Foreign Patents, patents in process,
//     and are protected by trade secret or copyright law.
//     Dissemination of this information or reproduction of this
//     material is strictly forbidden unless prior written
//     permission is obtained from Sitetheory.
//
//     For full details and documentation:
//     http://docs.sitetheory.io
!function(e,t){"function"==typeof define&&define.amd?define(["stratus","zepto","underscore","moment","moment-range","stratus.views.widgets.base","fullcalendar"],t):t(e.Stratus,e.$,e._,e.moment)}(this,function(e,t,n,a){e.Views.Widgets.Calendar=e.Views.Widgets.Base.extend({model:e.Models.Generic,template:n.template(""),url:"/Api/",options:{"private":{requiredCssFile:[e.BaseUrl+"sitetheorystratus/stratus/bower_components/fullcalendar/dist/fullcalendar.min.css"]},"public":{cssFile:[e.BaseUrl+"sitetheorystratus/stratus/views/widgets/calendar.css"],customButtons:null,buttonIcons:{prev:"left-single-arrow",next:"right-single-arrow",prevYear:"left-double-arrow",nextYear:"right-double-arrow"},header:{left:"prev,next today",center:"title",right:"month,agendaWeek,agendaDay"},defaultView:"month",defaultDate:null,nowIndicator:!1,timezone:!1,eventForceAllDay:!1,eventLimit:7,eventLimitClick:"popover",fixedWeekCount:!1,firstDay:0,weekends:!0,hiddenDays:[],weekNumbers:!1,weekNumberCalculation:"local",businessHours:!1,RTL:!1,height:null,contentHeight:null,aspectRatio:1.35,handleWindowResize:!0,windowResizeDelay:100}},initialRequest:!0,startRange:a(),endRange:a(),onRender:function(e){var t=this;return t.setupCustomView(),t.$el.fullCalendar({customButtons:t.options.customButtons,buttonIcons:t.options.buttonIcons,header:t.options.header,defaultView:t.options.defaultView,defaultDate:t.options.defaultDate,nowIndicator:t.options.nowIndicator,timezone:t.options.timezone,eventLimit:t.options.eventLimit,eventLimitClick:t.options.eventLimitClick,fixedWeekCount:t.options.fixedWeekCount,firstDay:t.options.firstDay,weekends:t.options.weekends,hiddenDays:t.options.hiddenDays,weekNumbers:t.options.weekNumbers,weekNumberCalculation:t.options.weekNumberCalculation,businessHours:t.options.businessHours,isRTL:t.options.RTL,height:t.options.height,contentHeight:t.options.contentHeight,aspectRatio:t.options.aspectRatio,handleWindowResize:t.options.handleWindowResize,windowResizeDelay:t.options.windowResizeDelay,events:function(e,i,n,a){t.startRange<=e&&(e=null),t.endRange>=i&&(i=null),null!=e&&null!=i?(t.startRange=e,t.endRange=i):null==e&&null!=i?(e=t.endRange,t.endRange=i):null==i&&null!=e&&(i=t.startRange,t.startRange=e),t.initialRequest||null==e||null==i?(a(t.parseEvents()),t.initialRequest=!1):(t.collection.once("success",function(){console.log("Calendar fetch data: ",e.format(),i.format()),a(t.parseEvents())}),t.collection.meta.set("api.startRange",e.format("X")),t.collection.meta.set("api.endRange",i.format("X")),t.collection.refresh())}}),!0},parseEvents:function(e){var t=this,i=[];return n.each(t.collection.toJSON().payload,function(e){e.viewVersion?i.push({id:e.id,title:e.viewVersion.title,start:a.unix(e.viewVersion.timeCustom||e.viewVersion.timePublish||e.time).format(),end:t.options.eventForceAllDay&&e.viewVersion.meta.allDay||!e.viewVersion.meta.timeEnd?null:a.unix(e.viewVersion.meta.timeEnd).format(),url:e.routingPrimary.url,allDay:t.options.eventForceAllDay||e.viewVersion.meta.allDay}):i.push({id:e.id,title:e.name,start:a.unix(e.time).format(),url:"//"+e.url+(e.extension?"."+e.extension:null),allDay:t.options.eventForceAllDay})}),e&&e(i),i},setupCustomView:function(){var e=t.fullCalendar;e.ListView=e.View.extend({isMomentInRange:function(e){var t=a.range(this.intervalStart,this.intervalEnd);return e.within(t)},isEventInRange:function(e){if(e.end){var t=a.range(this.intervalStart,this.intervalEnd),i=a.range(e.start,e.end);return i.overlaps(t)}return this.isMomentInRange(e.start)},prepareEvents:function(e){var t,n,a,s=[];for(i in e)if(e.hasOwnProperty(i)&&this.isEventInRange(e[i]))for(t=e[i].start.clone(),n=e[i].end?e[i].end.clone():e[i].start.clone();n>=t;)this.isMomentInRange(t)&&(a=Object.create(e[i]),a.displayDay=t.clone(),s.push(a)),t.add(1,"day");return s.sort(function(e,t){var i=new Date(e.displayDay),n=new Date(t.displayDay);return i-n}),s},renderEvents:function(n,s){console.log("Rending Events");var o,l,r,d,c,u,m,p,f,v,h,w=this.prepareEvents(n),y=this.opt("viewName")||"list",g=t('<ul class="fc-'+y+'"></ul>'),D=0;for(i in w)w.hasOwnProperty(i)&&(o=l=r=d=c=u=m=p=f=null,D++,o=a(w[i].displayDay).format(this.opt("leftHeaderFormat")),l=a(w[i].displayDay).format(this.opt("rightHeaderFormat")),v=a(w[i].displayDay).format("LL"),d=e.htmlEscape(w[i].title),c=w[i].allDay,u=e.htmlEscape(a(w[i].start).format(this.opt("eventTimeFormat"))),w[i].end&&(m=e.htmlEscape(a(w[i].end).format(this.opt("eventTimeFormat")))),r=w[i].url,p=w[i].className,f=w[i].description,w[i].source&&(p=p.concat(w[i].source.className)),v!=h&&(t('<li class="fc-dayHeader"><span class="fc-headerLeft">'+o+'</span><span class="fc-headerRight">'+l+"</span></li>").appendTo(g),h=v),c?$eventdisplay=t('<li class="fc-item"><'+(r?'a href="'+e.htmlEscape(r)+'"':"div")+' class="fc-listEvent '+p+'"><div class="fc-time"><span class="fc-all-day">'+this.opt("allDayText")+'</span></div><div class="fc-details"><div class="fc-title">'+d+"</div>"+(f?'<div class="fc-desc">'+e.htmlEscape(f)+"</div>":"")+"</div></"+(r?"a":"div")+"></li>").appendTo(g):$eventdisplay=t('<li class="fc-item"><'+(r?'a href="'+e.htmlEscape(r)+'"':"div")+' class="fc-listEvent '+p+'"><div class="fc-time"><span class="fc-start-time">'+u+'</span> <span class="fc-end-time">'+(m?m:"")+'</span></div><div class="fc-details"><div class="fc-title">'+d+"</div>"+(f?'<div class="fc-desc">'+e.htmlEscape(f)+"</div>":"")+"</div></"+(r?"a":"div")+"></li>").appendTo(g));t(this.el).html(g),this.trigger("eventAfterAllRender")}}),e.views.listMonth={duration:{months:1},defaults:{viewName:"list",eventTimeFormat:"LT",leftHeaderFormat:"dddd",rightHeaderFormat:"MMMM Do",allDayText:"All Day",buttonText:"month"},"class":e.ListView},e.views.listWeek={duration:{weeks:1},defaults:{viewName:"list",eventTimeFormat:"LT",leftHeaderFormat:"dddd",rightHeaderFormat:"MMMM Do",allDayText:"All Day",buttonText:"week"},"class":e.ListView}}})});